{% extends "base.html" %}

{% block title %}Inventory - {{ super() }}{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <div class="row align-items-center">
                    <div class="col-md-6">
                        <h4 class="mb-0">
                            <i data-feather="package"></i> Inventory Items
                        </h4>
                    </div>
                    <div class="col-md-6">
                        <form method="POST" class="d-flex">
                            <input type="text" name="search" class="form-control" placeholder="Search inventory..." 
                                   value="{{ search }}" id="searchInput">
                            <button type="submit" class="btn btn-outline-secondary ms-2">
                                <i data-feather="search"></i>
                            </button>
                        </form>
                    </div>
                </div>
            </div>
            <div class="card-body">
                {% if items %}
                <div class="table-responsive">
                    <table class="table table-hover" id="inventoryTable">
                        <thead class="table-dark">
                            <tr>
                                <th>Item</th>
                                <th>Category</th>
                                <th>Subcategory</th>
                                <th>Brand/Type</th>
                                <th>Length/Capacity</th>
                                <th>Quantity</th>
                                <th>Notes</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in items %}
                            <tr class="inventory-item">
                                <td><strong class="text-primary">{{ item['Item'] }}</strong></td>
                                <td>{{ item['Category'] }}</td>
                                <td>{{ item['Subcategory'] if item['Subcategory'] and item['Subcategory'].strip() else '-' }}</td>
                                <td>{{ item['Brand/Type'] if item['Brand/Type'] and item['Brand/Type'].strip() else '-' }}</td>
                                <td>{{ item['Length/Capacity'] if item['Length/Capacity'] and item['Length/Capacity'].strip() else '-' }}</td>
                                <td>
                                    <span class="badge {{ 'bg-warning' if item['Quantity'] <= 5 else 'bg-success' }}">
                                        {{ item['Quantity'] }}
                                    </span>
                                </td>
                                <td>
                                    <div class="text-truncate" style="max-width: 150px;" title="{{ item['Notes'] if item['Notes'] and item['Notes'].strip() else '' }}">
                                        {{ item['Notes'] if item['Notes'] and item['Notes'].strip() else '-' }}
                                    </div>
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm" role="group">
                                        <a href="{{ url_for('update', row=loop.index0) }}" class="btn btn-outline-primary btn-sm">
                                            <i data-feather="edit" size="14"></i>
                                        </a>
                                        <form method="POST" action="{{ url_for('remove', row=loop.index0) }}" 
                                              style="display: inline;" 
                                              onsubmit="return confirm('Are you sure you want to remove this item?')">
                                            <button type="submit" class="btn btn-outline-danger btn-sm">
                                                <i data-feather="trash" size="14"></i>
                                            </button>
                                        </form>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-5">
                    <i data-feather="package" size="64" class="text-muted mb-3"></i>
                    <h5 class="text-muted">No inventory items found</h5>
                    {% if search %}
                    <p class="text-muted">No items match your search for "{{ search }}"</p>
                    <a href="{{ url_for('index') }}" class="btn btn-secondary">Clear Search</a>
                    {% else %}
                    <p class="text-muted">Start by adding your first item to the inventory</p>
                    <a href="{{ url_for('add') }}" class="btn btn-primary">
                        <i data-feather="plus"></i> Add First Item
                    </a>
                    {% endif %}
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Real-time search functionality
let searchTimeout;
document.getElementById('searchInput').addEventListener('input', function(e) {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(function() {
        const query = e.target.value;
        if (query.length >= 2 || query.length === 0) {
            fetch(`/search?search=${encodeURIComponent(query)}`)
                .then(response => response.json())
                .then(data => {
                    updateInventoryTable(data.items);
                })
                .catch(error => console.error('Search error:', error));
        }
    }, 300);
});

function updateInventoryTable(items) {
    const tableBody = document.querySelector('#inventoryTable tbody');
    const tableContainer = document.querySelector('.table-responsive');
    
    if (items.length === 0) {
        tableContainer.innerHTML = `
            <div class="text-center py-5">
                <i data-feather="search" size="64" class="text-muted mb-3"></i>
                <h5 class="text-muted">No items found</h5>
                <p class="text-muted">Try adjusting your search criteria</p>
            </div>
        `;
        feather.replace();
        return;
    }
    
    let html = '';
    items.forEach((item, index) => {
        const quantityBadge = item.Quantity <= 5 ? 'bg-warning' : 'bg-success';
        const subcategory = item.Subcategory && item.Subcategory.trim() !== '' ? item.Subcategory : '-';
        const brandType = item['Brand/Type'] && item['Brand/Type'].trim() !== '' ? item['Brand/Type'] : '-';
        const lengthCapacity = item['Length/Capacity'] && item['Length/Capacity'].trim() !== '' ? item['Length/Capacity'] : '-';
        const notes = item.Notes && item.Notes.trim() !== '' ? item.Notes : '-';
        
        html += `
            <tr class="inventory-item">
                <td><strong class="text-primary">${item.Item || ''}</strong></td>
                <td>${item.Category || ''}</td>
                <td>${subcategory}</td>
                <td>${brandType}</td>
                <td>${lengthCapacity}</td>
                <td>
                    <span class="badge ${quantityBadge}">
                        ${item.Quantity || 0}
                    </span>
                </td>
                <td>
                    <div class="text-truncate" style="max-width: 150px;" title="${notes}">
                        ${notes}
                    </div>
                </td>
                <td>
                    <div class="btn-group btn-group-sm" role="group">
                        <a href="/update/${index}" class="btn btn-outline-primary btn-sm">
                            <i data-feather="edit" size="14"></i>
                        </a>
                        <form method="POST" action="/remove/${index}" 
                              style="display: inline;" 
                              onsubmit="return confirm('Are you sure you want to remove this item?')">
                            <button type="submit" class="btn btn-outline-danger btn-sm">
                                <i data-feather="trash" size="14"></i>
                            </button>
                        </form>
                    </div>
                </td>
            </tr>
        `;
    });
    
    if (!document.querySelector('#inventoryTable')) {
        tableContainer.innerHTML = `
            <table class="table table-hover" id="inventoryTable">
                <thead class="table-dark">
                    <tr>
                        <th>Item</th>
                        <th>Category</th>
                        <th>Subcategory</th>
                        <th>Brand/Type</th>
                        <th>Length/Capacity</th>
                        <th>Quantity</th>
                        <th>Notes</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>${html}</tbody>
            </table>
        `;
    } else {
        tableBody.innerHTML = html;
    }
    feather.replace();
}
</script>
{% endblock %}
